# Workflow for api-* branches
# Handles API broker, authentication, and gateway services

name: API Branch Pipeline

on:
  push:
    branches:
      - 'api-*'
  pull_request:
    branches:
      - 'api-*'

# Limit permissions for security
permissions:
  contents: read

concurrency:
  group: api-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '18'
  NEXT_TELEMETRY_DISABLED: 1

jobs:
  # Validate API service changes
  validate:
    name: Validate API Service
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Validate service structure
        run: |
          echo "## API Service Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for api-broker service
          if [ -d "services/api-broker" ]; then
            echo "✅ API Broker service found" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ API Broker service not found in services/" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for deafauth service
          if [ -d "services/deafauth" ]; then
            echo "✅ DeafAuth service found" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ DeafAuth service not found in services/" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for API routes
          if [ -d "app/api" ]; then
            echo "✅ API routes found" >> $GITHUB_STEP_SUMMARY
            API_ROUTES=$(find app/api -name "route.ts" | wc -l)
            echo "  - Found $API_ROUTES route files" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ API routes directory not found" >> $GITHUB_STEP_SUMMARY
          fi

  # Run lint for API services
  lint:
    name: Lint API Services
    needs: validate
    uses: ./.github/workflows/_reusable-lint.yml
    with:
      node-version: '18'

  # Run tests for API services
  test:
    name: Test API Services
    needs: [validate, lint]
    uses: ./.github/workflows/_reusable-test.yml
    with:
      node-version: '18'
      environment: local

  # Build for API services
  build:
    name: Build API Services
    needs: [validate, lint]
    uses: ./.github/workflows/_reusable-build.yml
    with:
      node-version: '18'
      environment: local

  # API-specific quality checks
  api-quality:
    name: API Quality Checks
    runs-on: ubuntu-latest
    needs: [lint, test, build]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Check TypeScript types
        run: npx tsc --noEmit || echo "TypeScript check completed"
        continue-on-error: true

      - name: Validate API endpoints
        run: |
          echo "## API Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### API Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # List all API routes
          if [ -d "app/api" ]; then
            echo "| Endpoint | Status |" >> $GITHUB_STEP_SUMMARY
            echo "| -------- | ------ |" >> $GITHUB_STEP_SUMMARY
            for route in $(find app/api -name "route.ts" | sort); do
              endpoint=$(dirname $route | sed 's|app/api||')
              if [ -z "$endpoint" ]; then
                endpoint="/"
              fi
              echo "| /api$endpoint | ✅ Found |" >> $GITHUB_STEP_SUMMARY
            done
          fi

  # Generate API pipeline report
  report:
    name: Generate API Report
    runs-on: ubuntu-latest
    needs: [validate, lint, test, build, api-quality]
    if: always()
    steps:
      - name: Generate report
        run: |
          echo "## API Branch Pipeline Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | ------ |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ needs.validate.result == 'success' && '✅ Success' || needs.validate.result == 'failure' && '❌ Failed' || '⏭️ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && '✅ Success' || needs.lint.result == 'failure' && '❌ Failed' || '⏭️ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result == 'success' && '✅ Success' || needs.test.result == 'failure' && '❌ Failed' || '⏭️ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && '✅ Success' || needs.build.result == 'failure' && '❌ Failed' || '⏭️ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Quality | ${{ needs.api-quality.result == 'success' && '✅ Success' || needs.api-quality.result == 'failure' && '❌ Failed' || '⏭️ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Branch Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
