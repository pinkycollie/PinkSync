# Enhanced Test Automation Workflow
# Comprehensive testing including unit, integration, smoke, and browser compatibility tests

name: Test Automation

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      test-type:
        description: 'Type of tests to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - unit
          - integration
          - smoke
          - e2e
          - browser

permissions:
  contents: read
  checks: write

concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '18'
  NEXT_TELEMETRY_DISABLED: 1

jobs:
  # Unit Tests
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test-type == 'all' || github.event.inputs.test-type == 'unit' || github.event.inputs.test-type == '' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run unit tests
        run: npm run test:unit

      - name: Generate test summary
        if: always()
        run: |
          echo "## Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Unit tests completed" >> $GITHUB_STEP_SUMMARY

  # Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test-type == 'all' || github.event.inputs.test-type == 'integration' || github.event.inputs.test-type == '' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run integration tests
        run: npm run test:integration

      - name: Generate test summary
        if: always()
        run: |
          echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Integration tests completed" >> $GITHUB_STEP_SUMMARY

  # Smoke Tests
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test-type == 'all' || github.event.inputs.test-type == 'smoke' || github.event.inputs.test-type == '' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run smoke tests
        run: npm run test:smoke

      - name: Generate test summary
        if: always()
        run: |
          echo "## Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Smoke tests completed - critical paths validated" >> $GITHUB_STEP_SUMMARY

  # Coverage Report
  test-coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test-type == 'all' || github.event.inputs.test-type == '' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Generate coverage summary
        if: always()
        run: |
          echo "## Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage/coverage-summary.json ]; then
            echo "ðŸ“Š Coverage report generated successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Coverage report not found" >> $GITHUB_STEP_SUMMARY
          fi

  # Browser Compatibility Tests
  browser-tests:
    name: Browser Compatibility Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test-type == 'all' || github.event.inputs.test-type == 'e2e' || github.event.inputs.test-type == 'browser' || github.event.inputs.test-type == '' }}
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install Playwright browsers
        run: npm run playwright:install

      - name: Build application
        run: npm run build

      - name: Run browser tests - ${{ matrix.browser }}
        run: npx playwright test --project=${{ matrix.browser }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-results-${{ matrix.browser }}
          path: test-results/
          retention-days: 30

      - name: Generate test summary
        if: always()
        run: |
          echo "## Browser Compatibility - ${{ matrix.browser }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Tests completed for ${{ matrix.browser }}" >> $GITHUB_STEP_SUMMARY

  # AI Service Validation
  ai-validation:
    name: AI Service Validation
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test-type == 'all' || github.event.inputs.test-type == '' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run AI validation tests
        run: npx vitest run tests/unit/ai-validation.test.ts

      - name: Generate validation summary
        if: always()
        run: |
          echo "## AI Service Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… AI service validation completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Validated:" >> $GITHUB_STEP_SUMMARY
          echo "- Speed benchmarks" >> $GITHUB_STEP_SUMMARY
          echo "- Correctness validation" >> $GITHUB_STEP_SUMMARY
          echo "- ASL recognition accuracy" >> $GITHUB_STEP_SUMMARY
          echo "- Transcription quality" >> $GITHUB_STEP_SUMMARY
          echo "- Visual alert generation" >> $GITHUB_STEP_SUMMARY

  # Final Test Report
  test-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, smoke-tests, test-coverage, browser-tests, ai-validation]
    if: always()
    steps:
      - name: Generate comprehensive test report
        run: |
          echo "# ðŸ§ª PinkSync Test Automation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Suite Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "| ---------- | ------ |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result == 'success' && 'âœ… Passed' || needs.unit-tests.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result == 'success' && 'âœ… Passed' || needs.integration-tests.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ needs.smoke-tests.result == 'success' && 'âœ… Passed' || needs.smoke-tests.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage Report | ${{ needs.test-coverage.result == 'success' && 'âœ… Generated' || needs.test-coverage.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Browser Tests | ${{ needs.browser-tests.result == 'success' && 'âœ… Passed' || needs.browser-tests.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AI Validation | ${{ needs.ai-validation.result == 'success' && 'âœ… Passed' || needs.ai-validation.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Accessibility Testing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All tests prioritize deaf accessibility features" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Browser compatibility validated across platforms" >> $GITHUB_STEP_SUMMARY
          echo "âœ… AI services validated for speed and accuracy" >> $GITHUB_STEP_SUMMARY

      - name: Check for test failures
        if: ${{ needs.unit-tests.result == 'failure' || needs.integration-tests.result == 'failure' || needs.smoke-tests.result == 'failure' || needs.browser-tests.result == 'failure' }}
        run: exit 1
