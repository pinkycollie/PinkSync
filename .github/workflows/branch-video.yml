# Workflow for video-* branches
# Handles video processing, Sign-Speak integration, and vCODE services

name: Video Branch Pipeline

on:
  push:
    branches:
      - 'video-*'
  pull_request:
    branches:
      - 'video-*'

# Limit permissions for security
permissions:
  contents: read

concurrency:
  group: video-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '18'
  NEXT_TELEMETRY_DISABLED: 1

jobs:
  # Validate video service changes
  validate:
    name: Validate Video Service
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Validate service structure
        run: |
          echo "## Video Service Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for vcode service
          if [ -d "services/vcode" ]; then
            echo "✅ vCODE service found" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ vCODE service not found in services/" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for sign-speak service
          if [ -d "services/sign-speak" ]; then
            echo "✅ Sign-Speak service found" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ Sign-Speak service not found in services/" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for interpreters service
          if [ -d "services/interpreters" ]; then
            echo "✅ Interpreters service found" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ Interpreters service not found in services/" >> $GITHUB_STEP_SUMMARY
          fi

  # Run lint for video services
  lint:
    name: Lint Video Services
    needs: validate
    uses: ./.github/workflows/_reusable-lint.yml
    with:
      node-version: '18'

  # Run tests for video services
  test:
    name: Test Video Services
    needs: [validate, lint]
    uses: ./.github/workflows/_reusable-test.yml
    with:
      node-version: '18'
      environment: local

  # Build for video services
  build:
    name: Build Video Services
    needs: [validate, lint]
    uses: ./.github/workflows/_reusable-build.yml
    with:
      node-version: '18'
      environment: local

  # Video-specific quality checks
  video-quality:
    name: Video Quality Checks
    runs-on: ubuntu-latest
    needs: [lint, test, build]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Check TypeScript types
        run: npx tsc --noEmit || echo "TypeScript check completed"
        continue-on-error: true

      - name: Validate video service exports
        run: |
          echo "## Video Service Quality" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check service exports
          for service in services/vcode services/sign-speak services/interpreters; do
            if [ -f "$service/index.ts" ]; then
              echo "✅ $service has index.ts" >> $GITHUB_STEP_SUMMARY
            fi
          done

  # Generate video pipeline report
  report:
    name: Generate Video Report
    runs-on: ubuntu-latest
    needs: [validate, lint, test, build, video-quality]
    if: always()
    steps:
      - name: Generate report
        run: |
          echo "## Video Branch Pipeline Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | ------ |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ needs.validate.result == 'success' && '✅ Success' || needs.validate.result == 'failure' && '❌ Failed' || '⏭️ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && '✅ Success' || needs.lint.result == 'failure' && '❌ Failed' || '⏭️ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result == 'success' && '✅ Success' || needs.test.result == 'failure' && '❌ Failed' || '⏭️ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && '✅ Success' || needs.build.result == 'failure' && '❌ Failed' || '⏭️ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Video Quality | ${{ needs.video-quality.result == 'success' && '✅ Success' || needs.video-quality.result == 'failure' && '❌ Failed' || '⏭️ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Branch Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
