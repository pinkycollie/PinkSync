# Workflow for data-* branches
# Handles data processing, ETL, and database-related services

name: Data Branch Pipeline

on:
  push:
    branches:
      - 'data-*'
  pull_request:
    branches:
      - 'data-*'

# Limit permissions for security
permissions:
  contents: read

concurrency:
  group: data-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '18'
  NEXT_TELEMETRY_DISABLED: 1

jobs:
  # Validate data service changes
  validate:
    name: Validate Data Service
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Validate service structure
        run: |
          echo "## Data Service Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for RAG engine service
          if [ -d "services/rag-engine" ]; then
            echo "✅ RAG Engine service found" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ RAG Engine service not found in services/" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for workers service
          if [ -d "services/workers" ]; then
            echo "✅ Workers service found" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ Workers service not found in services/" >> $GITHUB_STEP_SUMMARY
          fi

  # Run lint for data services
  lint:
    name: Lint Data Services
    needs: validate
    uses: ./.github/workflows/_reusable-lint.yml
    with:
      node-version: '18'

  # Run tests for data services
  test:
    name: Test Data Services
    needs: [validate, lint]
    uses: ./.github/workflows/_reusable-test.yml
    with:
      node-version: '18'
      environment: local

  # Build for data services
  build:
    name: Build Data Services
    needs: [validate, lint]
    uses: ./.github/workflows/_reusable-build.yml
    with:
      node-version: '18'
      environment: local

  # Data-specific quality checks
  data-quality:
    name: Data Quality Checks
    runs-on: ubuntu-latest
    needs: [lint, test, build]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Check TypeScript types
        run: npx tsc --noEmit || echo "TypeScript check completed"
        continue-on-error: true

      - name: Validate data service exports
        run: |
          echo "## Data Service Quality" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check service exports
          for service in services/rag-engine services/workers; do
            if [ -f "$service/index.ts" ]; then
              echo "✅ $service has index.ts" >> $GITHUB_STEP_SUMMARY
            fi
          done

  # Generate data pipeline report
  report:
    name: Generate Data Report
    runs-on: ubuntu-latest
    needs: [validate, lint, test, build, data-quality]
    if: always()
    steps:
      - name: Generate report
        run: |
          echo "## Data Branch Pipeline Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | ------ |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ needs.validate.result == 'success' && '✅ Success' || needs.validate.result == 'failure' && '❌ Failed' || '⏭️ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && '✅ Success' || needs.lint.result == 'failure' && '❌ Failed' || '⏭️ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result == 'success' && '✅ Success' || needs.test.result == 'failure' && '❌ Failed' || '⏭️ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && '✅ Success' || needs.build.result == 'failure' && '❌ Failed' || '⏭️ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Data Quality | ${{ needs.data-quality.result == 'success' && '✅ Success' || needs.data-quality.result == 'failure' && '❌ Failed' || '⏭️ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Branch Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
