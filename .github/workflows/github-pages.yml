name: Deploy to GitHub Pages (Staging)

'on':
  push:
    branches:
      - main
      - staging
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      snapshot_name:
        description: 'Snapshot name (optional)'
        required: false
        type: string

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build for staging
        run: |
          # Build with staging config
          npm run build
        env:
          NODE_ENV: staging
          NEXT_PUBLIC_PLATFORM_ENV: staging
          NEXT_PUBLIC_API_URL: https://api.mbtq.dev
          NEXT_PUBLIC_AUTH_URL: https://auth.mbtq.dev
          # Add base path for GitHub Pages
          NEXT_PUBLIC_BASE_PATH: /PinkSync

      - name: Add snapshot metadata
        if: github.event.inputs.snapshot_name != ''
        run: |
          SNAPSHOT_FILE=out/SNAPSHOT.txt
          echo "Snapshot: ${{ github.event.inputs.snapshot_name }}" \
            > ${SNAPSHOT_FILE}
          echo "Build Date: $(date -u)" >> ${SNAPSHOT_FILE}
          echo "Commit: ${{ github.sha }}" >> ${SNAPSHOT_FILE}

      - name: Create .nojekyll file
        run: touch out/.nojekyll

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: |
          github.ref == 'refs/heads/main' ||
          github.ref == 'refs/heads/staging'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out
          publish_branch: gh-pages
          commit_message: 'Deploy staging build: ${{ github.sha }}'

      - name: Deploy PR Preview
        uses: peaceiris/actions-gh-pages@v3
        if: github.event_name == 'pull_request'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out
          publish_branch: gh-pages
          destination_dir: >-
            previews/pr-${{ github.event.pull_request.number }}
          commit_message: >-
            Deploy PR #${{ github.event.pull_request.number }} preview

      - name: Comment PR with preview link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const previewUrl =
              `https://pinkycollie.github.io/PinkSync/previews/pr-${prNumber}/`;
            const commitSha =
              context.payload.pull_request.head.sha.substring(0, 7);
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸš€ Preview Deployed!\n\n` +
                    `**Preview URL:** ${previewUrl}\n\n` +
                    `**Build:** ${context.sha}\n` +
                    `**Commit:** ${commitSha}`
            })
