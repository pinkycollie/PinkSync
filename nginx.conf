### File layout

```jsx
.
├─ app/                # FastAPI app (main.py in app/)
├─ nginx/
│  ├─ nginx.conf
│  └─ conf.d/pinksync.conf
├─ supervisord.conf
├─ requirements.txt
└─ Dockerfile
```

### nginx/nginx.conf

```jsx
user  nginx;
worker_processes  auto;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
	worker_connections  1024;
}

http {
	include       /etc/nginx/mime.types;
	default_type  application/octet-stream;
	log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
	                  '$status $body_bytes_sent "$http_referer" '
	                  '"$http_user_agent" "$http_x_forwarded_for"';
	access_log  /var/log/nginx/access.log  main;
	sendfile        on;
	keepalive_timeout  65;
	gzip on;
	gzip_types text/plain text/css application/json application/javascript application/xml+rss;

	include /etc/nginx/conf.d/*.conf;
}
```

### nginx/conf.d/pinksync.conf

```jsx
# Cloud Run injects PORT; fall back to 3002 locally
map $http_upgrade $connection_upgrade {
	default upgrade;
	''      close;
}

upstream app_upstream {
	server 127.0.0.1:3002;  # App server (PinkSync)
}

server {
	listen       ${PORT};
	server_name  _;

	# Static assets
	location /static/ {
		alias /app/static/;
		expires 7d;
		add_header Cache-Control "public, max-age=604800";
	}

	# API + WebSocket proxy
	location / {
		proxy_set_header Host              $host;
		proxy_set_header X-Real-IP         $remote_addr;
		proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;

		# WebSocket
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection $connection_upgrade;

		proxy_pass http://app_upstream;
		proxy_read_timeout 3600s;
	}
}
```

### supervisord.conf (run NGINX + Uvicorn)

```
[supervisord]
nodaemon=true
logfile=/dev/stdout
loglevel=info

[program:uvicorn]
command=uvicorn app.main:app --host 0.0.0.0 --port 3002 --workers 2
priority=10
autorestart=true
stdout_logfile=/dev/stdout
stderr_logfile=/dev/stderr

[program:nginx]
command=/usr/sbin/nginx -g 'daemon off;'
priority=20
autorestart=true
stdout_logfile=/dev/stdout
stderr_logfile=/dev/stderr
```

### Dockerfile (NGINX + Python app)

```docker
FROM python:3.11-slim
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PORT=3002

# System deps
RUN apt-get update && apt-get install -y --no-install-recommends \
    nginx supervisor curl ca-certificates \
 && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt

# App code and configs
COPY app/ /app/app/
COPY nginx/ /etc/nginx/
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Health check (adjust path if needed)
HEALTHCHECK --interval=30s --timeout=5s --retries=3 CMD curl -fsS http://127.0.0.1:${PORT}/healthz || exit 1

EXPOSE 3002
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
```

### Security headers (optional)

Add inside location /:

```
add_header X-Content-Type-Options nosniff;
add_header X-Frame-Options DENY;
add_header Referrer-Policy no-referrer-when-downgrade;
add_header Content-Security-Policy "default-src 'self'; connect-src 'self' wss: https:; img-src 'self' data:; script-src 'self'; style-src 'self' 'unsafe-inline'";
```

### Local run

```bash
docker build -t pinksync-nginx .
docker run -p 3002:3002 --env PORT=3002 pinksync-nginx
```

